#!/bin/bash
set -e
set -x

SCRIPTDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
jspath=$(realpath $1)
outputpath=$(realpath $2)
configpath=$(realpath $3)
JAR=target/seguard-1.0-SNAPSHOT-jar-with-dependencies.jar
cd $SCRIPTDIR
if [ -z "$BATCH_RUN" ]; then
    make
fi
tmpfile=$(mktemp /tmp/abc-script.XXXXXX)
tmpfile2=$(mktemp /tmp/abc-script.XXXXXX)
java -jar $JAR --lang js --js $jspath --mode entrypoints --sourceSinkFile $SCRIPTDIR/config/SourcesAndSinksJS.txt --outputPath $tmpfile --config $configpath
cat $jspath $tmpfile > $tmpfile2
java -jar $JAR --lang js --js $tmpfile2 --mode core --sourceSinkFile $SCRIPTDIR/config/SourcesAndSinksJS.txt --outputPath $outputpath --config $configpath
